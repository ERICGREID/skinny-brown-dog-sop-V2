<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skinny Brown Dog Media - Publishing Workflow Tracker</title>
    <style>
        :root {
            --primary: #1a56db;
            --primary-dark: #1e429f;
            --secondary: #64748b;
            --accent: #3b82f6;
            --light: #f3f4f6;
            --white: #ffffff;
            --gray-100: #f9fafb;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-700);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--white);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
            border-radius: 8px;
        }
        
        /* [All your existing CSS styles remain exactly the same] */
        
        /* Add this new style for the Google Drive section */
        .google-drive-status {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
    <div class="container">
        <header>
            <img src="https://via.placeholder.com/300x80?text=Skinny+Brown+Dog+Media" alt="Skinny Brown Dog Media Logo">
            <h1>Book Publishing Workflow Tracker</h1>
        </header>
        
        <!-- [All your existing HTML content remains the same until the Import/Export section] -->
        
        <!-- Import/Export Section -->
        <div class="import-export-section">
            <h2>Import/Export Project Data</h2>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div>
                    <input type="file" id="importFile" class="file-input" accept=".json">
                    <label for="importFile" class="file-label">Import Project</label>
                    <span id="fileName" class="file-name"></span>
                </div>
                <button type="button" id="exportButton" class="success">Export Project</button>
            </div>
        </div>

        <!-- Google Drive Backup Section -->
        <div class="import-export-section">
            <h2>Google Drive Backup</h2>
            <div id="google-drive-container" style="margin-top: 15px;">
                <div id="auth-status" class="google-drive-status" style="background-color: #e5e7eb;">
                    Not connected to Google Drive
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button type="button" id="authButton" class="success">Connect to Google Drive</button>
                    <button type="button" id="saveToGDriveBtn" disabled style="opacity: 0.5">Save to Google Drive</button>
                    <button type="button" id="loadFromGDriveBtn" disabled style="opacity: 0.5">Load from Google Drive</button>
                </div>
            </div>
        </div>
        
        <!-- [Rest of your existing HTML remains exactly the same] -->
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // [All your existing JavaScript code remains the same until the auto-save interval]
                
                // Auto save every 5 minutes
                setInterval(function() {
                    if (currentProjectId && (document.getElementById('bookTitle').value.trim() !== '' || 
                        document.getElementById('authorName').value.trim() !== '')) {
                        saveCurrentProject();
                        console.log('Auto-saved at ' + new Date().toLocaleTimeString());
                    }
                }, 300000); // 5 minutes

               // Google Drive API configuration
const API_KEY = 'AIzaSyBTE9Yarj-5e_3iGkPLqehBnjP8Iolh6hE'; // Corrected to AIza
const CLIENT_ID = '720585651306-eimrp5hqb6srs3r0gkht1qjj59hie2dk.apps.googleusercontent.com';
const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

                // Auth button elements
                const authButton = document.getElementById('authButton');
                const saveToGDriveBtn = document.getElementById('saveToGDriveBtn');
                const loadFromGDriveBtn = document.getElementById('loadFromGDriveBtn');
                const authStatus = document.getElementById('auth-status');

                // Initialize the Google API client
                function initGoogleApi() {
                    gapi.load('client:auth2', () => {
                        gapi.client.init({
                            apiKey: API_KEY,
                            clientId: CLIENT_ID,
                            discoveryDocs: DISCOVERY_DOCS,
                            scope: SCOPES
                        }).then(() => {
                            // Listen for sign-in state changes
                            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                            
                            // Handle the initial sign-in state
                            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                            
                            // Add click handler for the auth button
                            authButton.onclick = handleAuthClick;
                        }).catch(error => {
                            console.error('Error initializing Google API client:', error);
                            authStatus.textContent = 'Error connecting to Google Drive';
                            authStatus.style.backgroundColor = '#ef4444';
                            authStatus.style.color = 'white';
                        });
                    });
                }

                // Update UI based on sign-in status
                function updateSigninStatus(isSignedIn) {
                    if (isSignedIn) {
                        authStatus.textContent = 'Connected to Google Drive';
                        authStatus.style.backgroundColor = '#10b981';
                        authStatus.style.color = 'white';
                        authButton.textContent = 'Disconnect from Google Drive';
                        
                        // Enable the Drive buttons
                        saveToGDriveBtn.disabled = false;
                        saveToGDriveBtn.style.opacity = '1';
                        loadFromGDriveBtn.disabled = false;
                        loadFromGDriveBtn.style.opacity = '1';
                        
                        // Add click handlers for the Drive buttons
                        saveToGDriveBtn.onclick = saveToGoogleDrive;
                        loadFromGDriveBtn.onclick = loadFromGoogleDrive;
                    } else {
                        authStatus.textContent = 'Not connected to Google Drive';
                        authStatus.style.backgroundColor = '#e5e7eb';
                        authStatus.style.color = 'black';
                        authButton.textContent = 'Connect to Google Drive';
                        
                        // Disable the Drive buttons
                        saveToGDriveBtn.disabled = true;
                        saveToGDriveBtn.style.opacity = '0.5';
                        loadFromGDriveBtn.disabled = true;
                        loadFromGDriveBtn.style.opacity = '0.5';
                    }
                }

                // Handle auth button click
                function handleAuthClick() {
                    if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                        // Sign out
                        gapi.auth2.getAuthInstance().signOut();
                    } else {
                        // Sign in
                        gapi.auth2.getAuthInstance().signIn();
                    }
                }

                // Save current project to Google Drive
                function saveToGoogleDrive() {
                    if (!currentProjectId || 
                        document.getElementById('bookTitle').value.trim() === '' || 
                        document.getElementById('authorName').value.trim() === '') {
                        alert('Please make sure you have a project with at least Book Title and Author Name before saving to Google Drive.');
                        return;
                    }
                    
                    saveCurrentProject();
                    
                    const projects = getProjects();
                    const project = projects[currentProjectId];
                    const fileName = `${project.data.projectDetails.bookTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${project.data.projectDetails.authorName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                    const fileContent = JSON.stringify(project);
                    const blob = new Blob([fileContent], {type: 'application/json'});
                    
                    gapi.client.drive.files.list({
                        q: `name='${fileName}' and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id, name)'
                    }).then(response => {
                        const files = response.result.files;
                        
                        if (files && files.length > 0) {
                            const fileId = files[0].id;
                            updateFileOnDrive(fileId, fileName, blob);
                        } else {
                            createFileOnDrive(fileName, blob);
                        }
                    }).catch(error => {
                        console.error('Error searching for file:', error);
                        alert('Error connecting to Google Drive.');
                    });
                }

                function updateFileOnDrive(fileId, fileName, blob) {
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify({
                        name: fileName,
                        mimeType: 'application/json'
                    })], {type: 'application/json'}));
                    form.append('file', blob);
                    
                    fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({
                            'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token
                        }),
                        body: form
                    }).then(response => {
                        if (response.ok) {
                            alert('Project updated successfully in Google Drive!');
                        } else {
                            alert('Error updating file in Google Drive.');
                        }
                    }).catch(error => {
                        console.error('Error updating file:', error);
                        alert('Error updating file in Google Drive.');
                    });
                }

                function createFileOnDrive(fileName, blob) {
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify({
                        name: fileName,
                        mimeType: 'application/json'
                    })], {type: 'application/json'}));
                    form.append('file', blob);
                    
                    fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({
                            'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token
                        }),
                        body: form
                    }).then(response => {
                        if (response.ok) {
                            alert('Project saved successfully to Google Drive!');
                        } else {
                            alert('Error saving file to Google Drive.');
                        }
                    }).catch(error => {
                        console.error('Error creating file:', error);
                        alert('Error saving file to Google Drive.');
                    });
                }

                // Load project from Google Drive
                function loadFromGoogleDrive() {
                    gapi.client.drive.files.list({
                        q: "mimeType='application/json' and trashed=false",
                        spaces: 'drive',
                        fields: 'files(id, name)'
                    }).then(response => {
                        const files = response.result.files;
                        
                        if (files && files.length > 0) {
                            showFileSelectionModal(files);
                        } else {
                            alert('No project files found in Google Drive.');
                        }
                    }).catch(error => {
                        console.error('Error listing files:', error);
                        alert('Error accessing files in Google Drive.');
                    });
                }

                function showFileSelectionModal(files) {
                    const modal = document.createElement('div');
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    modal.style.zIndex = '1000';
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.backgroundColor = 'white';
                    modalContent.style.padding = '20px';
                    modalContent.style.borderRadius = '8px';
                    modalContent.style.maxWidth = '500px';
                    modalContent.style.width = '90%';
                    
                    const modalHeader = document.createElement('h3');
                    modalHeader.textContent = 'Select a project to load';
                    modalHeader.style.marginBottom = '15px';
                    
                    const modalList = document.createElement('ul');
                    modalList.style.listStyle = 'none';
                    modalList.style.padding = '0';
                    modalList.style.maxHeight = '300px';
                    modalList.style.overflowY = 'auto';
                    
                    files.forEach(file => {
                        const listItem = document.createElement('li');
                        listItem.style.padding = '10px';
                        listItem.style.borderBottom = '1px solid #e5e7eb';
                        listItem.style.cursor = 'pointer';
                        listItem.textContent = file.name.replace('.json', '').replace(/_/g, ' ');
                        
                        listItem.addEventListener('mouseenter', () => {
                            listItem.style.backgroundColor = '#f3f4f6';
                        });
                        
                        listItem.addEventListener('mouseleave', () => {
                            listItem.style.backgroundColor = 'transparent';
                        });
                        
                        listItem.addEventListener('click', () => {
                            loadProjectFromDrive(file.id);
                            document.body.removeChild(modal);
                        });
                        
                        modalList.appendChild(listItem);
                    });
                    
                    const closeButton = document.createElement('button');
                    closeButton.textContent = 'Cancel';
                    closeButton.style.marginTop = '15px';
                    closeButton.style.padding = '8px 16px';
                    closeButton.style.backgroundColor = '#6b7280';
                    closeButton.style.color = 'white';
                    closeButton.style.border = 'none';
                    closeButton.style.borderRadius = '4px';
                    closeButton.style.cursor = 'pointer';
                    
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                    
                    modalContent.appendChild(modalHeader);
                    modalContent.appendChild(modalList);
                    modalContent.appendChild(closeButton);
                    modal.appendChild(modalContent);
                    
                    document.body.appendChild(modal);
                }

                function loadProjectFromDrive(fileId) {
                    gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    }).then(response => {
                        const project = response.result;
                        const newProjectId = 'project_' + Date.now();
                        project.id = newProjectId;
                        
                        const projects = getProjects();
                        projects[newProjectId] = project;
                        localStorage.setItem('publishingProjects', JSON.stringify(projects));
                        
                        loadProjectsList();
                        loadProject(newProjectId);
                        refreshClientOverview();
                        
                        alert('Project loaded successfully from Google Drive!');
                    }).catch(error => {
                        console.error('Error downloading file:', error);
                        alert('Error downloading file from Google Drive.');
                    });
                }

                // Initialize the Google API when the page loads
                initGoogleApi();
            });
        </script>
    </div>
</body>
</html>
